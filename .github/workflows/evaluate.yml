name: Evaluate Submission

on:
  pull_request_target:
    paths:
      - 'submissions/**'

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout trusted code (main branch)
      - uses: actions/checkout@v4
        with:
          ref: main

      # 2️⃣ Fetch submission file from the PR
      - name: Fetch submission from PR
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          git checkout pr -- submissions/submission.parquet

      # 3️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4️⃣ Install dependencies
      - name: Install dependencies
        run: |
          pip install pandas pyarrow scikit-learn

      # 5️⃣ Clone private labels repo
      - name: Clone private labels repo
        env:
          EVAL_TOKEN: ${{ secrets.EVAL_TOKEN }}
        run: |
          git clone https://${EVAL_TOKEN}@github.com/abdksm/gnn-challenge-private.git private_labels

      # 6️⃣ Run scoring
      - name: Run scoring
        run: |
          python scoring_script.py submissions/submission.parquet private_labels/test_labels.parquet score.txt
          cp score.txt /tmp/score.txt

      # 7️⃣ Prepare repo for pushing leaderboard update
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # 8️⃣ Update leaderboard
      - name: Update leaderboard
        run: |
          git config user.name "challenge-bot"
          git config user.email "challenge-bot@users.noreply.github.com"
          git checkout main
          python update_leaderboard.py /tmp/score.txt leaderboard.md "${{ github.event.pull_request.user.login }}"

      # 9️⃣ Commit and push leaderboard
      - name: Commit leaderboard update
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          git add leaderboard.md
          git commit -m "Update leaderboard"
          git push https://${BOT_TOKEN}@github.com/abdksm/gnn-challenge.git main
